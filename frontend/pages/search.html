<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†æ£€ç´¢ - åŸå­ç‰©ç†æ™ºèƒ½è¯¾å ‚ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš›ï¸</text></svg>">
    <style>
        /* æœç´¢é¡µé¢ç‰¹å®šæ ·å¼ */
        .search-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .search-box {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--space-2xl);
            position: relative;
            overflow: hidden;
        }

        .search-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-main), var(--accent-gold), var(--primary-main));
        }

        .search-form {
            display: flex;
            gap: var(--space-md);
            align-items: flex-end;
        }

        .search-input-group {
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: var(--space-lg);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            transition: all var(--transition-normal);
            background: var(--bg-primary);
        }

        .search-input:focus {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
            background: white;
        }

        .search-button {
            min-width: 120px;
            height: 56px;
            border-radius: var(--radius-lg);
        }

        .search-filters {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-lg);
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .filter-select {
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            font-size: 0.875rem;
        }

        /* ç”¨æˆ·åŒºåŸŸæ ·å¼ */
        .user-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid rgba(45, 90, 71, 0.1);
            border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(45, 90, 71, 0.08);
        }

        .user-section:hover {
            background: linear-gradient(135deg, #ffffff 0%, #faf8f5 100%);
            border-color: var(--accent-gold);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.15);
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.3rem;
            box-shadow: 0 3px 10px rgba(45, 90, 71, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .user-avatar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
            opacity: 0;
        }

        .user-section:hover .user-avatar::before {
            opacity: 1;
            transform: rotate(45deg) translate(50%, 50%);
        }

        .user-section:hover .user-avatar {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(45, 90, 71, 0.4);
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .username {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 0.95rem;
            line-height: 1.2;
        }

        .user-role {
            font-size: 0.8rem;
            color: #6c757d;
            background: linear-gradient(135deg, rgba(45, 90, 71, 0.1) 0%, rgba(45, 90, 71, 0.05) 100%);
            padding: 0.3rem 0.6rem;
            border-radius: 10px;
            font-weight: 500;
            border: 1px solid rgba(45, 90, 71, 0.1);
        }

        .user-section .btn-ghost {
            background: transparent;
            border: 1px solid rgba(45, 90, 71, 0.2);
            color: var(--primary-dark);
            padding: 0.5rem 1.2rem;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .user-section .btn-ghost::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(45, 90, 71, 0.1), transparent);
            transition: left 0.4s;
        }

        .user-section .btn-ghost:hover::before {
            left: 100%;
        }

        .user-section .btn-ghost:hover {
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-light) 100%);
            color: white;
            border-color: transparent;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 90, 71, 0.3);
        }

        .results-container {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .results-header {
            padding: var(--space-xl);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-md);
        }

        .results-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .results-actions {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .results-sort {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .pdf-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #c9a961 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }

        .pdf-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .pdf-link-btn:active {
            transform: translateY(0);
        }

        .results-list {
            padding: var(--space-lg);
        }

        .result-item {
            padding: var(--space-xl);
            border-bottom: 1px solid var(--border-light);
            transition: all var(--transition-normal);
            position: relative;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item:hover {
            background: var(--bg-secondary);
            transform: translateX(4px);
        }

        .result-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: var(--accent-gold);
            transition: width var(--transition-normal);
        }

        .result-item:hover::before {
            width: 4px;
        }

        .result-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: var(--space-sm);
            line-height: 1.4;
        }

        .result-snippet {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: var(--space-md);
        }

        .result-meta {
            display: flex;
            gap: var(--space-lg);
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .result-score {
            background: var(--primary-main);
            color: white;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .result-source {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .highlight {
            background: var(--accent-gold);
            color: var(--primary-dark);
            padding: 0.125em 0.25em;
            border-radius: var(--radius-sm);
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: var(--space-3xl);
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--space-lg);
            opacity: 0.5;
        }

        .suggested-searches {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            justify-content: center;
            margin-top: var(--space-xl);
        }

        .suggested-search {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-full);
            padding: var(--space-sm) var(--space-md);
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .suggested-search:hover {
            background: var(--primary-main);
            color: white;
            border-color: var(--primary-main);
            transform: translateY(-2px);
        }

        .loading-results {
            text-align: center;
            padding: var(--space-3xl);
        }

        .loading-skeleton {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            height: 20px;
            margin-bottom: var(--space-md);
            position: relative;
            overflow: hidden;
        }

        .loading-skeleton::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: shimmer 1.5s infinite;
        }

        .skeleton-title { width: 70%; height: 24px; }
        .skeleton-text { width: 100%; }
        .skeleton-short { width: 40%; }

        /* æ¨¡å¼åˆ‡æ¢æ ‡ç­¾ */
        .mode-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(248, 249, 250, 0.8);
            padding: 0.5rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .mode-tab {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: transparent;
            color: #6c757d;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .mode-tab:hover {
            color: #495057;
            background: rgba(255, 255, 255, 0.6);
        }

        .mode-tab.active {
            color: #ffffff;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-light) 100%);
            box-shadow: 0 4px 15px rgba(45, 90, 71, 0.3);
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        /* çŸ¥è¯†ç‚¹ç›®å½•æ ·å¼ */
        .browse-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .knowledge-catalog {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            border: 1px solid rgba(45, 90, 71, 0.1);
        }

        .catalog-header {
            padding: 2.5rem 2rem;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-light) 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .catalog-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.08'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3Ccircle cx='10' cy='10' r='3'/%3E%3Ccircle cx='50' cy='10' r='3'/%3E%3Ccircle cx='10' cy='50' r='3'/%3E%3Ccircle cx='50' cy='50' r='3'/%3E%3C/g%3E%3C/svg%3E") repeat;
            opacity: 0.6;
        }

        .catalog-header > * {
            position: relative;
            z-index: 1;
        }

        .catalog-header h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .catalog-header p {
            margin: 0;
            opacity: 0.95;
            font-size: 1rem;
        }

        .catalog-chapters {
            padding: 1.5rem;
        }

        .chapter-item {
            margin-bottom: 1rem;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            border: 1px solid rgba(45, 90, 71, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .chapter-item:hover {
            box-shadow: 0 4px 16px rgba(45, 90, 71, 0.15);
            transform: translateY(-2px);
        }

        .chapter-header {
            padding: 1.25rem 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            user-select: none;
        }

        .chapter-item:hover .chapter-header {
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-light) 100%);
            color: white;
        }

        .chapter-icon {
            font-size: 0.875rem;
            display: inline-block;
        }

        .chapter-title {
            flex: 1;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
                gap: var(--space-md);
            }
            
            .search-button {
                width: 100%;
            }
            
            .search-filters {
                flex-direction: column;
                gap: var(--space-sm);
            }
            
            .results-header {
                flex-direction: column;
                gap: var(--space-md);
                align-items: flex-start;
            }
            
            .result-meta {
                flex-direction: column;
                gap: var(--space-sm);
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="container">
                <div class="nav-brand">
                    <h1><a href="../index.html" style="color: inherit;">âš›ï¸ åŸå­ç‰©ç†æ™ºèƒ½è¯¾å ‚</a></h1>
                </div>
                <div class="nav-menu">
                    <a href="search.html" class="nav-link active">çŸ¥è¯†æ£€ç´¢</a>
                    <a href="qa.html" class="nav-link">æ™ºèƒ½é—®ç­”</a>
                    <a href="recommend.html" class="nav-link">å­¦ä¹ æ¨è</a>
                    <a href="profile.html" class="nav-link">å­¦æƒ…åˆ†æ</a>
                    <a href="teacher.html" class="nav-link teacher-only" style="display: none;">æ•™å¸ˆç«¯</a>
                </div>
                <div class="nav-user">
                    <!-- æœªç™»å½•çŠ¶æ€ -->
                    <div id="login-section" class="login-section">
                        <button id="login-btn" class="btn btn-primary btn-sm">ğŸ” ç™»å½•</button>
                    </div>
                    
                    <!-- å·²ç™»å½•çŠ¶æ€ -->
                    <div id="user-section" class="user-section" style="display: none;">
                        <div class="user-avatar" id="user-avatar">
                            <span id="avatar-text">U</span>
                        </div>
                        <div class="user-info">
                            <span id="username" class="username">ç”¨æˆ·å</span>
                            <span id="user-role" class="user-role">å­¦ç”Ÿ</span>
                        </div>
                        <button id="logout-btn" class="btn btn-ghost btn-sm">é€€å‡º</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="container">
                <div class="page-header">
                    <h1 class="page-title">çŸ¥è¯†æ£€ç´¢ç³»ç»Ÿ</h1>
                    <p class="page-subtitle">å¿«é€Ÿæœç´¢åŸå­ç‰©ç†å­¦ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œè·å–ç²¾å‡†çš„æ¦‚å¿µè§£é‡Šå’Œç†è®ºé˜è¿°</p>
                </div>

                <div class="search-container">
                    <!-- æ¨¡å¼åˆ‡æ¢æ ‡ç­¾ -->
                    <div class="mode-tabs">
                        <button class="mode-tab active" data-mode="search">æœç´¢æ¨¡å¼</button>
                        <button class="mode-tab" data-mode="browse">æµè§ˆæ¨¡å¼</button>
                    </div>

                    <!-- æœç´¢æ¨¡å¼ -->
                    <div id="search-mode" class="mode-content active">
                        <!-- æœç´¢æ¡† -->
                        <div class="search-box">
                        <form id="search-form" class="search-form">
                            <div class="search-input-group">
                                <input type="text" id="search-input" class="search-input" 
                                       placeholder="è¯·è¾“å…¥æ‚¨è¦æœç´¢çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šæ³¢ç²’äºŒè±¡æ€§ã€åŸå­è½¨é“..." 
                                       required>
                            </div>
                            <button type="submit" class="btn btn-primary search-button">
                                <span class="search-text">æœç´¢</span>
                                <span class="loading" style="display: none;"></span>
                            </button>
                        </form>
                        
                        <div class="search-filters">
                            <div class="filter-group">
                                <label for="top-k">ç»“æœæ•°é‡:</label>
                                <select id="top-k" class="filter-select">
                                    <option value="5">5ä¸ªç»“æœ</option>
                                    <option value="10" selected>10ä¸ªç»“æœ</option>
                                    <option value="20">20ä¸ªç»“æœ</option>
                                    <option value="50">50ä¸ªç»“æœ</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="sort-by">æ’åºæ–¹å¼:</label>
                                <select id="sort-by" class="filter-select">
                                    <option value="relevance" selected>ç›¸å…³æ€§</option>
                                    <option value="date">æ—¶é—´</option>
                                    <option value="score">è¯„åˆ†</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- æœç´¢ç»“æœ -->
                    <div class="results-container" id="results-container" style="display: none;">
                        <div class="results-header">
                            <div class="results-count" id="results-count">
                                æ‰¾åˆ° 0 ä¸ªç›¸å…³ç»“æœ
                            </div>
                            <div class="results-actions">
                                <button id="related-pdf-btn" class="pdf-link-btn" style="display: none;" onclick="openRelatedPDF()">
                                    ğŸ“„ æŸ¥çœ‹ç›¸å…³æ•™æ¡ˆ
                                </button>
                                <div class="results-sort">
                                    <span>æœç´¢ç”¨æ—¶: <span id="search-time">0</span>ms</span>
                                </div>
                            </div>
                        </div>
                        <div class="results-list" id="results-list">
                            <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div class="empty-state" id="empty-state">
                        <p>è¾“å…¥å…³é”®è¯æœç´¢åŸå­ç‰©ç†å­¦ç›¸å…³å†…å®¹ï¼Œå‘ç°çŸ¥è¯†çš„å¥¥ç§˜</p>
                        <div class="suggested-searches">
                            <span class="suggested-search" onclick="performSearch('æ³¢ç²’äºŒè±¡æ€§')">æ³¢ç²’äºŒè±¡æ€§</span>
                            <span class="suggested-search" onclick="performSearch('åŸå­ç»“æ„')">åŸå­ç»“æ„</span>
                            <span class="suggested-search" onclick="performSearch('é‡å­æ•°')">é‡å­æ•°</span>
                            <span class="suggested-search" onclick="performSearch('åŸå­è½¨é“')">åŸå­è½¨é“</span>
                            <span class="suggested-search" onclick="performSearch('ç”µå­è‡ªæ—‹')">ç”µå­è‡ªæ—‹</span>
                            <span class="suggested-search" onclick="performSearch('è–›å®šè°”æ–¹ç¨‹')">è–›å®šè°”æ–¹ç¨‹</span>
                            <span class="suggested-search" onclick="performSearch('é‡å­åŠ›å­¦')">é‡å­åŠ›å­¦</span>
                            <span class="suggested-search" onclick="performSearch('åŸå­å…‰è°±')">åŸå­å…‰è°±</span>
                        </div>
                    </div>

                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div class="loading-results" id="loading-results" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p class="loading-text">æ­£åœ¨æœç´¢çŸ¥è¯†åº“...</p>
                        
                        <!-- éª¨æ¶å± -->
                        <div style="margin-top: 2rem;">
                            <div class="loading-skeleton skeleton-title"></div>
                            <div class="loading-skeleton skeleton-text"></div>
                            <div class="loading-skeleton skeleton-short"></div>
                            <br>
                            <div class="loading-skeleton skeleton-title"></div>
                            <div class="loading-skeleton skeleton-text"></div>
                            <div class="loading-skeleton skeleton-short"></div>
                        </div>
                    </div>
                </div>

                <!-- æµè§ˆæ¨¡å¼ -->
                <div id="browse-mode" class="mode-content">
                    <div class="browse-container">
                        <!-- çŸ¥è¯†ç‚¹ç›®å½• -->
                        <div class="knowledge-catalog">
                            <div class="catalog-header">
                                <h3 style="color: white;">åŸå­ç‰©ç†å­¦çŸ¥è¯†ä½“ç³»</h3>
                                <p>æŒ‰ç« èŠ‚æµè§ˆæ‰€æœ‰çŸ¥è¯†ç‚¹</p>
                            </div>
                            
                            <div class="catalog-chapters">
                                <!-- ç¬¬1ç«  -->
                                <div class="chapter-item" onclick="viewChapter('ç¬¬1ç«  åŸå­çš„åŸºæœ¬çŠ¶å†µ')">
                                    <div class="chapter-header">
                                        <span class="chapter-icon">â–¶</span>
                                        <span class="chapter-title">ç¬¬1ç«  åŸå­çš„åŸºæœ¬çŠ¶å†µ</span>
                                    </div>
                                </div>

                                <!-- ç¬¬2ç«  -->
                                <div class="chapter-item" onclick="viewChapter('ç¬¬2ç«  åŸå­çš„èƒ½çº§å’Œè¾å°„')">
                                    <div class="chapter-header">
                                        <span class="chapter-icon">â–¶</span>
                                        <span class="chapter-title">ç¬¬2ç«  åŸå­çš„èƒ½çº§å’Œè¾å°„</span>
                                    </div>
                                </div>

                                <!-- ç¬¬3ç«  -->
                                <div class="chapter-item" onclick="viewChapter('ç¬¬3ç«  é‡å­åŠ›å­¦åˆæ­¥')">
                                    <div class="chapter-header">
                                        <span class="chapter-icon">â–¶</span>
                                        <span class="chapter-title">ç¬¬3ç«  é‡å­åŠ›å­¦åˆæ­¥</span>
                                    </div>
                                </div>

                                <!-- ç¬¬4ç«  -->
                                <div class="chapter-item" onclick="viewChapter('ç¬¬4ç«  ç¢±é‡‘å±åŸå­å’Œç”µå­è‡ªæ—‹')">
                                    <div class="chapter-header">
                                        <span class="chapter-icon">â–¶</span>
                                        <span class="chapter-title">ç¬¬4ç«  ç¢±é‡‘å±åŸå­å’Œç”µå­è‡ªæ—‹</span>
                                    </div>
                                </div>

                                <!-- ç¬¬5ç«  -->
                                <div class="chapter-item" onclick="viewChapter('ç¬¬5ç«  å¤šç”µå­åŸå­')">
                                    <div class="chapter-header">
                                        <span class="chapter-icon">â–¶</span>
                                        <span class="chapter-title">ç¬¬5ç«  å¤šç”µå­åŸå­</span>
                                    </div>
                                </div>

                                <!-- ç¬¬6ç«  -->
                                <div class="chapter-item" onclick="viewChapter('ç¬¬6ç«  å¤–åœºä¸­çš„åŸå­')">
                                    <div class="chapter-header">
                                        <span class="chapter-icon">â–¶</span>
                                        <span class="chapter-title">ç¬¬6ç«  å¤–åœºä¸­çš„åŸå­</span>
                                    </div>
                                </div>

                                <!-- ç¬¬8ç«  -->
                                <div class="chapter-item" onclick="viewChapter('ç¬¬8ç«  Xå°„çº¿')">
                                    <div class="chapter-header">
                                        <span class="chapter-icon">â–¶</span>
                                        <span class="chapter-title">ç¬¬8ç«  Xå°„çº¿</span>
                                    </div>
                                </div>

                                <!-- ç¬¬10ç«  -->
                                <div class="chapter-item" onclick="viewChapter('ç¬¬10ç«  åŸå­æ ¸')">
                                    <div class="chapter-header">
                                        <span class="chapter-icon">â–¶</span>
                                        <span class="chapter-title">ç¬¬10ç«  åŸå­æ ¸</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- é¡µè„š -->
        <footer class="footer">
            <div class="container">
                <p>&copy; 2026åŸå­ç‰©ç†æ™ºèƒ½è¯¾å ‚ç³»ç»Ÿ | æ¢ç´¢å¾®è§‚ä¸–ç•Œï¼Œå¯å‘ç§‘å­¦æ€ç»´</p>
            </div>
        </footer>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="../assets/js/utils.js?v=4"></script>
    <script src="../assets/js/api.js?v=4"></script>
    <script src="../assets/js/modals.js?v=4"></script>
    <script src="../assets/js/auth.js?v=4"></script>
    <script src="../assets/js/event.js?v=4"></script>

    <script>
        let currentCourseId = 1; // é»˜è®¤è¯¾ç¨‹ID
        let searchStartTime = 0;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initAuth();
            recordEvent('view_search', {});
            
            // ç»‘å®šæ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchMode(this.dataset.mode);
                });
            });
            
            // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰æœç´¢æŸ¥è¯¢
            const urlParams = getUrlParams();
            if (urlParams.q) {
                document.getElementById('search-input').value = urlParams.q;
                performSearch(urlParams.q);
            }
            
            // æ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰æœç´¢æŸ¥è¯¢
            const savedQuery = localStorage.getItem('searchQuery');
            if (savedQuery && !urlParams.q) {
                document.getElementById('search-input').value = savedQuery;
                performSearch(savedQuery);
                localStorage.removeItem('searchQuery');
            }
        });

        // åˆ‡æ¢æ¨¡å¼
        function switchMode(mode) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.mode-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${mode}-mode`).classList.add('active');
            
            // è®°å½•äº‹ä»¶
            recordEvent('switch_search_mode', { mode: mode });
        }

        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰ç›¸å…³çš„PDF
        let currentRelatedPDF = null;

        // æ£€æµ‹æœ€ç›¸å…³çš„PDFæ–‡æ¡£
        function detectRelatedPDF(hits) {
            const pdfBtn = document.getElementById('related-pdf-btn');
            
            if (!hits || hits.length === 0) {
                pdfBtn.style.display = 'none';
                return;
            }

            // ç« èŠ‚å…³é”®è¯æ˜ å°„
            const chapterKeywords = {
                'ç¬¬1ç«  åŸå­çš„åŸºæœ¬çŠ¶å†µ': ['åŸå­', 'åŸºæœ¬', 'çŠ¶å†µ', 'ç»„æˆ', 'ç”µå­äº‘', 'åŸå­æ ¸'],
                'ç¬¬2ç«  åŸå­çš„èƒ½çº§å’Œè¾å°„': ['èƒ½çº§', 'è¾å°„', 'å…‰è°±', 'ç»å°”', 'æ°¢åŸå­'],
                'ç¬¬3ç«  é‡å­åŠ›å­¦åˆæ­¥': ['é‡å­', 'æ³¢ç²’äºŒè±¡æ€§', 'å¾·å¸ƒç½—æ„', 'è–›å®šè°”', 'æ³¢å‡½æ•°', 'ä¸ç¡®å®šæ€§'],
                'ç¬¬4ç«  ç¢±é‡‘å±åŸå­å’Œç”µå­è‡ªæ—‹': ['ç¢±é‡‘å±', 'ç”µå­è‡ªæ—‹', 'è‡ªæ—‹é‡å­æ•°'],
                'ç¬¬5ç«  å¤šç”µå­åŸå­': ['å¤šç”µå­', 'æ³¡åˆ©', 'ç”µå­ç»„æ€', 'æ´ªç‰¹'],
                'ç¬¬6ç«  å¤–åœºä¸­çš„åŸå­': ['å¤–åœº', 'å¡æ›¼', 'æ–¯å¡”å…‹', 'ç£åœº'],
                'ç¬¬8ç«  Xå°„çº¿': ['Xå°„çº¿', 'åº·æ™®é¡¿'],
                'ç¬¬10ç«  åŸå­æ ¸': ['åŸå­æ ¸', 'æ ¸åŠ›', 'æ”¾å°„æ€§', 'æ ¸ååº”']
            };

            const chapterPdfMap = {
                'ç¬¬1ç«  åŸå­çš„åŸºæœ¬çŠ¶å†µ': 'ç¬¬1ç«  åŸå­çš„åŸºæœ¬çŠ¶å†µ-å«æ³¨é‡Š.pdf',
                'ç¬¬2ç«  åŸå­çš„èƒ½çº§å’Œè¾å°„': 'ç¬¬2ç«  åŸå­çš„èƒ½çº§å’Œè¾å°„-å«æ³¨é‡Š.pdf',
                'ç¬¬3ç«  é‡å­åŠ›å­¦åˆæ­¥': 'ç¬¬3ç«  é‡å­åŠ›å­¦åˆæ­¥-å«æ³¨é‡Š.pdf',
                'ç¬¬4ç«  ç¢±é‡‘å±åŸå­å’Œç”µå­è‡ªæ—‹': 'ç¬¬4ç«  ç¢±é‡‘å±åŸå­å’Œç”µå­è‡ªæ—‹-å«æ³¨é‡Š.pdf',
                'ç¬¬5ç«  å¤šç”µå­åŸå­': 'ç¬¬5ç«  å¤šç”µå­åŸå­-å«æ³¨é‡Š.pdf',
                'ç¬¬6ç«  å¤–åœºä¸­çš„åŸå­': 'ç¬¬6ç«  å¤–åœºä¸­çš„åŸå­-å«æ³¨é‡Š.pdf',
                'ç¬¬8ç«  Xå°„çº¿': 'ç¬¬8ç«  Xå°„çº¿-å«æ³¨é‡Š.pdf',
                'ç¬¬10ç«  åŸå­æ ¸': 'ç¬¬10ç«  åŸå­æ ¸-å«æ³¨é‡Š.pdf'
            };

            // è·å–æœç´¢ç»“æœçš„æ–‡æœ¬å†…å®¹
            const resultText = hits.map(hit => hit.snippet).join(' ');

            // è®¡ç®—æ¯ä¸ªç« èŠ‚çš„åŒ¹é…åˆ†æ•°
            let bestMatch = null;
            let bestScore = 0;

            for (const [chapter, keywords] of Object.entries(chapterKeywords)) {
                let score = 0;
                keywords.forEach(keyword => {
                    const regex = new RegExp(keyword, 'gi');
                    const matches = resultText.match(regex);
                    if (matches) {
                        score += matches.length;
                    }
                });

                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = chapter;
                }
            }

            // å¦‚æœæ‰¾åˆ°åŒ¹é…çš„ç« èŠ‚ï¼Œæ˜¾ç¤ºæŒ‰é’®
            if (bestMatch && bestScore > 0) {
                currentRelatedPDF = {
                    chapter: bestMatch,
                    filename: chapterPdfMap[bestMatch]
                };
                pdfBtn.style.display = 'inline-flex';
            } else {
                pdfBtn.style.display = 'none';
            }
        }

        // æ‰“å¼€ç›¸å…³PDF
        function openRelatedPDF() {
            if (!currentRelatedPDF) {
                alert('æœªæ‰¾åˆ°ç›¸å…³çš„PDFæ–‡æ¡£');
                return;
            }

            const pdfPath = `http://localhost:8000/materials/${encodeURIComponent(currentRelatedPDF.filename)}`;
            window.open(pdfPath, '_blank');
            
            // è®°å½•äº‹ä»¶
            recordEvent('view_related_pdf', { 
                chapter: currentRelatedPDF.chapter, 
                pdf: currentRelatedPDF.filename 
            });
        }

        // æŸ¥çœ‹ç« èŠ‚å®Œæ•´å†…å®¹
        function viewChapter(chapterTitle) {
            // ç« èŠ‚æ ‡é¢˜åˆ°PDFæ–‡ä»¶åçš„æ˜ å°„
            const chapterPdfMap = {
                'ç¬¬1ç«  åŸå­çš„åŸºæœ¬çŠ¶å†µ': 'ç¬¬1ç«  åŸå­çš„åŸºæœ¬çŠ¶å†µ-å«æ³¨é‡Š.pdf',
                'ç¬¬2ç«  åŸå­çš„èƒ½çº§å’Œè¾å°„': 'ç¬¬2ç«  åŸå­çš„èƒ½çº§å’Œè¾å°„-å«æ³¨é‡Š.pdf',
                'ç¬¬3ç«  é‡å­åŠ›å­¦åˆæ­¥': 'ç¬¬3ç«  é‡å­åŠ›å­¦åˆæ­¥-å«æ³¨é‡Š.pdf',
                'ç¬¬4ç«  ç¢±é‡‘å±åŸå­å’Œç”µå­è‡ªæ—‹': 'ç¬¬4ç«  ç¢±é‡‘å±åŸå­å’Œç”µå­è‡ªæ—‹-å«æ³¨é‡Š.pdf',
                'ç¬¬5ç«  å¤šç”µå­åŸå­': 'ç¬¬5ç«  å¤šç”µå­åŸå­-å«æ³¨é‡Š.pdf',
                'ç¬¬6ç«  å¤–åœºä¸­çš„åŸå­': 'ç¬¬6ç«  å¤–åœºä¸­çš„åŸå­-å«æ³¨é‡Š.pdf',
                'ç¬¬8ç«  Xå°„çº¿': 'ç¬¬8ç«  Xå°„çº¿-å«æ³¨é‡Š.pdf',
                'ç¬¬10ç«  åŸå­æ ¸': 'ç¬¬10ç«  åŸå­æ ¸-å«æ³¨é‡Š.pdf'
            };
            
            const pdfFileName = chapterPdfMap[chapterTitle];
            if (pdfFileName) {
                // é€šè¿‡åç«¯APIè®¿é—®PDFæ–‡ä»¶
                const pdfPath = `http://localhost:8000/materials/${encodeURIComponent(pdfFileName)}`;
                
                // åœ¨æ–°çª—å£æ‰“å¼€PDF
                window.open(pdfPath, '_blank');
                
                // è®°å½•äº‹ä»¶
                recordEvent('view_chapter_pdf', { chapter: chapterTitle, pdf: pdfFileName });
            } else {
                console.error('æœªæ‰¾åˆ°å¯¹åº”çš„PDFæ–‡ä»¶:', chapterTitle);
                alert('æŠ±æ­‰ï¼Œæœªæ‰¾åˆ°è¯¥ç« èŠ‚çš„PDFæ–‡ä»¶');
            }
        }

        // æœç´¢è¡¨å•æäº¤
        document.getElementById('search-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const query = document.getElementById('search-input').value.trim();
            if (!query) return;
            
            performSearch(query);
        });

        // æ‰§è¡Œæœç´¢
        async function performSearch(query) {
            const searchInput = document.getElementById('search-input');
            const emptyState = document.getElementById('empty-state');
            const loadingResults = document.getElementById('loading-results');
            const resultsContainer = document.getElementById('results-container');
            
            // æ›´æ–°è¾“å…¥æ¡†
            searchInput.value = query;
            
            // æ›´æ–°URL
            setUrlParam('q', query);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            emptyState.style.display = 'none';
            resultsContainer.style.display = 'none';
            loadingResults.style.display = 'block';
            
            searchStartTime = Date.now();
            
            try {
                const topK = parseInt(document.getElementById('top-k').value);
                const response = await kbAPI.searchKnowledge(query, currentCourseId, topK);
                
                console.log('API response:', response);
                console.log('Response hits:', response.hits);
                console.log('Hits length:', response.hits ? response.hits.length : 'undefined');
                
                const searchTime = Date.now() - searchStartTime;
                displayResults(response.hits, query, searchTime);
                
                // è®°å½•æœç´¢äº‹ä»¶
                recordEvent('search_knowledge', {
                    query: query,
                    results_count: response.hits.length,
                    search_time: searchTime
                });
                
            } catch (error) {
                console.error('Search error:', error);
                loadingResults.style.display = 'none';
                showNoResults(query);
                handleAPIError(error, 'çŸ¥è¯†æ£€ç´¢');
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displayResults(hits, query, searchTime) {
            console.log('displayResults called with hits:', hits, 'query:', query, 'searchTime:', searchTime);
            
            const loadingResults = document.getElementById('loading-results');
            const resultsContainer = document.getElementById('results-container');
            const resultsCount = document.getElementById('results-count');
            const searchTimeSpan = document.getElementById('search-time');
            const resultsList = document.getElementById('results-list');
            const pdfBtn = document.getElementById('related-pdf-btn');
            
            loadingResults.style.display = 'none';
            
            if (!hits || hits.length === 0) {
                console.log('No hits to display');
                showNoResults(query);
                return;
            }
            
            console.log('Displaying', hits.length, 'results');
            
            // æ›´æ–°ç»“æœç»Ÿè®¡
            resultsCount.textContent = `æ‰¾åˆ° ${hits.length} ä¸ªç›¸å…³ç»“æœ`;
            searchTimeSpan.textContent = searchTime;
            
            // æ£€æµ‹æœ€ç›¸å…³çš„PDFæ–‡æ¡£
            detectRelatedPDF(hits);
            
            // æ¸…ç©ºç»“æœåˆ—è¡¨
            resultsList.innerHTML = '';
            
            // æ·»åŠ ç»“æœé¡¹
            hits.forEach((hit, index) => {
                console.log('Creating result item for hit', index, hit);
                const resultItem = createResultItem(hit, query, index);
                resultsList.appendChild(resultItem);
            });
            
            console.log('Setting results container to visible');
            resultsContainer.style.display = 'block';
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            const items = resultsList.querySelectorAll('.result-item');
            items.forEach((item, index) => {
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    item.style.transition = 'all 0.4s ease-out';
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                }, index * 100);
            });
        }

        // åˆ›å»ºç»“æœé¡¹
        function createResultItem(hit, query, index) {
            const item = document.createElement('div');
            item.className = 'result-item';
            
            // é«˜äº®æœç´¢å…³é”®è¯
            const highlightedSnippet = highlightKeywords(hit.snippet, query);
            const highlightedTitle = highlightKeywords(`æ–‡æ¡£ç‰‡æ®µ ${index + 1}`, query);
            
            // è®¡ç®—ç›¸ä¼¼åº¦ç™¾åˆ†æ¯”
            const similarityPercent = Math.round(hit.score * 100);
            
            item.innerHTML = `
                <div class="result-title">${highlightedTitle}</div>
                <div class="result-snippet">${highlightedSnippet}</div>
                <div class="result-meta">
                    <div class="result-score">${similarityPercent}% åŒ¹é…</div>
                    <div class="result-source">
                        <span>æ–‡æ¡£</span>
                        <span>æ–‡æ¡£ID: ${hit.document_id}</span>
                    </div>
                    <div class="result-source">
                        <span>ç‰‡æ®µ</span>
                        <span>ç‰‡æ®µID: ${hit.chunk_id}</span>
                    </div>
                </div>
            `;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            item.addEventListener('click', function() {
                showResultDetail(hit);
            });
            
            return item;
        }

        // é«˜äº®å…³é”®è¯
        function highlightKeywords(text, query) {
            if (!query) return text;
            
            const keywords = query.split(/\s+/).filter(k => k.length > 0);
            let highlightedText = text;
            
            keywords.forEach(keyword => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                highlightedText = highlightedText.replace(regex, '<span class="highlight">$1</span>');
            });
            
            return highlightedText;
        }

        // æ˜¾ç¤ºæ— ç»“æœçŠ¶æ€
        function showNoResults(query) {
            const resultsContainer = document.getElementById('results-container');
            const resultsList = document.getElementById('results-list');
            const resultsCount = document.getElementById('results-count');
            
            resultsCount.textContent = 'æœªæ‰¾åˆ°ç›¸å…³ç»“æœ';
            resultsList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">æ— ç»“æœ</div>
                    <h3>æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</h3>
                    <p>æ²¡æœ‰æ‰¾åˆ°ä¸ "${query}" ç›¸å…³çš„å†…å®¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</p>
                    <div class="suggested-searches">
                        <span class="suggested-search" onclick="performSearch('æ³¢ç²’äºŒè±¡æ€§')">æ³¢ç²’äºŒè±¡æ€§</span>
                        <span class="suggested-search" onclick="performSearch('åŸå­ç»“æ„')">åŸå­ç»“æ„</span>
                        <span class="suggested-search" onclick="performSearch('é‡å­æ•°')">é‡å­æ•°</span>
                        <span class="suggested-search" onclick="performSearch('åŸå­è½¨é“')">åŸå­è½¨é“</span>
                    </div>
                </div>
            `;
            
            resultsContainer.style.display = 'block';
        }

        // æ˜¾ç¤ºç»“æœè¯¦æƒ…
        async function showResultDetail(hit) {
            // åˆ›å»ºåŠ è½½ä¸­çš„æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2 class="modal-title">ğŸ“„ æ–‡æ¡£å†…å®¹</h2>
                        <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div class="loading-placeholder">æ­£åœ¨åŠ è½½å®Œæ•´æ–‡æ¡£...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            try {
                // è·å–å®Œæ•´æ–‡æ¡£å†…å®¹
                const response = await fetch(`${API_BASE_URL}/kb/documents/${hit.document_id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–æ–‡æ¡£å¤±è´¥');
                }
                
                const document = await response.json();
                
                // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
                const modalBody = modal.querySelector('.modal-body');
                modalBody.innerHTML = `
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 2px solid var(--border-light);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-dark);">${document.filename || 'æ–‡æ¡£'}</h3>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">
                                    <span>ğŸ“„ æ–‡æ¡£ID: ${hit.document_id}</span>
                                    <span style="margin-left: 1rem;">ğŸ¯ åŒ¹é…åº¦: ${Math.round(hit.score * 100)}%</span>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="copyToClipboard(\`${document.content?.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                                ğŸ“‹ å¤åˆ¶å…¨æ–‡
                            </button>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); padding: 2rem; border-radius: 12px; line-height: 1.8; white-space: pre-wrap; font-family: var(--font-body); color: var(--text-primary); box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);">
                        ${document.content || hit.snippet}
                    </div>
                `;
                
            } catch (error) {
                console.error('è·å–æ–‡æ¡£å¤±è´¥:', error);
                // å¦‚æœè·å–å¤±è´¥ï¼Œæ˜¾ç¤ºç‰‡æ®µå†…å®¹
                const modalBody = modal.querySelector('.modal-body');
                modalBody.innerHTML = `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #fff3cd; border-radius: 8px; color: #856404;">
                        âš ï¸ æ— æ³•è·å–å®Œæ•´æ–‡æ¡£ï¼Œæ˜¾ç¤ºç‰‡æ®µå†…å®¹
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>ç›¸ä¼¼åº¦:</strong> ${Math.round(hit.score * 100)}%
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>æ–‡æ¡£ID:</strong> ${hit.document_id}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>ç‰‡æ®µå†…å®¹:</strong>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-md); line-height: 1.8; white-space: pre-wrap;">
                        ${hit.snippet}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>